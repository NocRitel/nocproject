<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Upload Tiket - NOC Tool</title>
  <style>
    body {
      background-color: #f4f6f8;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background-color: #fff;
      padding: 2rem 2.5rem;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      width: 500px;
      text-align: center;
    }

    h2 {
      margin-bottom: 1.2rem;
      color: #333;
    }

    input[type="file"] {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
    }

    button {
      background-color: #007BFF;
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .note {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: #666;
    }

    #previewArea {
      margin-top: 1.5rem;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Tiket NOC</h2>
    <input type="file" id="fileInput" accept=".txt" onchange="previewFile()" />
    <button onclick="uploadFile()">Upload Notepad</button>
    <p class="note">Format nama file: <b>PIC-SHIFT.txt</b><br>Contoh isi: <br>RWEXL4 => untuk Non Merge<br>RWE9XD- => untuk Merge<br>240293853028 => untuk Grup<br>RWEXD8+ => untuk Akses Web</p>
    <div id="previewArea"></div>
    <h3>Export Data by Month&Year</h3>
    <label for="year">Pilih Tahun:</label>
    <select id="year">
      <script>
        window.onload = function() {
        const yearSelect = document.getElementById("year");
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= 2020; y--) {
          const option = document.createElement("option");
          option.value = y;
          option.textContent = y;
          yearSelect.appendChild(option);
        }
      };
      </script>
    </select>

    <label for="month">Pilih Bulan:</label>
    <select id="month">
      <option value="01">Januari</option>
      <option value="02">Februari</option>
      <option value="03">Maret</option>
      <option value="04">April</option>
      <option value="05">Mei</option>
      <option value="06">Juni</option>
      <option value="07">Juli</option>
      <option value="08">Agustus</option>
      <option value="09">September</option>
      <option value="10">Oktober</option>
      <option value="11">November</option>
      <option value="12">Desember</option>
    </select>
    <button onclick="handleExport()">Export Data to CSV</button>
  </div>

  <script>
    // Fungsi untuk mendapatkan timestamp WIB
    function getWIBTimestamp() {
      const now = new Date();
      const offset = 7 * 60 * 60 * 1000;
      const wib = new Date(now.getTime() + offset);
      return wib.toISOString();
    }

    function getStatus(analisa) {
      if (/^\d+$/.test(analisa)) return "Grup";
      if (analisa.endsWith("-")) return "Tiket Merge";
      if (analisa.endsWith("+")) return "Tiket Akses Web";
      return "Tiket";
    }

    function getGroup(rawAnalisa) {
  // Pengecekan apakah rawAnalisa berisi kata "Grup"
      if (rawAnalisa.includes("Grup")) {
        return "Grup"; // Jika mengandung kata "Grup", statusnya adalah Grup
      }
      return ""; // Jika tidak ada kata "Grup", kembalikan kosong
    }

    function getTicketMerge(rawAnalisa) {
      // Pengecekan apakah rawAnalisa berisi kata "Tiket Merge"
      if (rawAnalisa.includes("Tiket Merge")) {
        return "Tiket Merge"; // Jika mengandung kata "Tiket Merge", statusnya adalah Tiket Merge
      }
      return ""; // Jika tidak ada kata "Tiket Merge", kembalikan kosong
    }

    function previewFile() {
      const fileInput = document.getElementById("fileInput");
      const previewArea = document.getElementById("previewArea");
      const file = fileInput.files[0];
      previewArea.innerHTML = '';

      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        if (lines.length === 0) {
          previewArea.innerHTML = "<p><i>File kosong</i></p>";
          return;
        }

        let table = "<table><thead><tr><th>No</th><th>Analisa</th><th>Status</th></tr></thead><tbody>";
        lines.forEach((line, index) => {
          const analisa = line.replace(/-$/, '');
          const status = getStatus(line);
          table += `<tr><td>${index + 1}</td><td>${analisa}</td><td>${status}</td></tr>`;
        });
        table += "</tbody></table>";
        previewArea.innerHTML = table;
      };
      reader.readAsText(file);
    }

    async function uploadFile() {
        const validPICs = [
            'bagus isnu wardhana',
            'muhammad rizki adi wibowo',
            'imam arifin',
            'abhie rafdi',
            'ade maulana apriadi (l2)',
            'afrizal salfarel',
            'agil septia pamungkas',
            'agus sapta permana',
            'ahmad nur arifat',
            'alifah nur hidayah',
            'amin ariyanto (l2)',
            'anang hidayat nur aziz',
            'andhika meyrawan',
            'annisa bunga salsabila',
            'anton wahyu',
            'auliya nisa nurfadzilla (l2)',
            'azzam abdullah umar (l2)',
            'banu putri pratiwi',
            'bayu raihan sanjaya',
            'bogi surya praja',
            'budi sulistiyo (l2)',
            'challesta prajna paramitha',
            'damar pradifatama',
            'desi dwi purwasih',
            'edi gumtoro',
            'edo yogapasha',
            'faridah istiyorini',
            'fortuna kahyangan',
            'hafildarani herofianti (l2)',
            'hendy septianto',
            'idris sapta pamungkas',
            'ikhsan maulana',
            'ilham bhagas putra pratama',
            'iqbal alya',
            'jihan shafira adini',
            'karunia larasati',
            'kelvin prayogi',
            'kinanti ninggar rahardani',
            'lugina ashari',
            'lutfi ahmad (l2)',
            'm. abd. rosyid wibowo',
            'malkan biyan aprialdi',
            'muhammad bintang sandi jannata',
            'muhammad chilmi irfanuddin (l2)',
            'muhammad farid',
            'muhammad hiksal daeng jb',
            'muhammad thoriq',
            'naila nazilatul fitri',
            'nawasakti ayunus',
            'nur rizki arifiansyah',
            'pramudhito herlambang (l2)',
            'rendiy compower jn hutapea',
            'risal ramadhan',
            'rizky wijaya (l2)',
            'rizqi ramadhani ahmad',
            'rizqi wahyu pratama (l2)',
            'romy ade mulyana (l2)',
            'roy mundo januardi (l2)',
            'ryan arya maulana',
            'satrio pratama rezky herdianata',
            'sayyid tajuddin (l2)',
            'shenya kameswari prima anydyaseta',
            'sindhu nirmala',
            'sultan yanuar',
            'syahdilla sekar ramadhani',
            'wisnu agung wicaksono',
            'yarjuna rahmatalbar',
            'yudo purnomo (l2)',
            'zaki mubarok',
            'zikrul naufal aqil (l2)',
            'zulfadhil kusuma nugraha'
        ];

        const validShifts = ["pagi", "siang", "malam"];
  
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) return alert("⚠️ Pilih file notepad terlebih dahulu.");

        const fileName = file.name.replace(".txt", "");
        const [rawPic, rawShift] = fileName.split("-");

        if (!rawPic || !rawShift) {
          return alert("⚠️ Nama file harus format: PIC-SHIFT.txt");
        }

        const pic = rawPic.trim().toLowerCase();
        const shift = rawShift.trim().toLowerCase();

        if (!validPICs.includes(pic)) {
          return alert(`❌ PIC "${rawPic}" tidak dikenali. Upload dibatalkan.`);
        }

        if (!validShifts.includes(shift)) {
          return alert(`❌ Shift "${rawShift}" tidak valid. Hanya boleh: pagi, siang, atau malam.`);
        }

        const text = await file.text();
        const lines = text.split("\n").map(line => line.trim()).filter(line => line.length > 0);
        if (lines.length === 0) return alert("⚠️ File kosong.");

        const timestamp = getWIBTimestamp();
        const statusCount = { 
          "Tiket": 0, 
          "Tiket Merge": 0, 
          "Grup": 0,
          "Tiket Akses Web": 0
        };

        // Array untuk menyimpan data yang sudah terproses
        const processedData = [];

        const data = lines.map(rawAnalisa => {
          const ticketMergeStatus = getTicketMerge(rawAnalisa);
          const groupStatus = getGroup(rawAnalisa);
          const status = ticketMergeStatus || groupStatus || getStatus(rawAnalisa);  // Prioritaskan status Tiket Merge atau Grup
          
          const analisa = rawAnalisa.replace(/\+$/, '').replace(/-$/, '');
          
          // Pengecekan duplikat untuk semua status
          if (processedData.some(item => 
              item["ANALISA"] === analisa && 
              (item.status === "Tiket" || item.status === "Tiket Merge" || item.status === "Tiket Akses Web" || item.status === "Grup")
          )) {
            alert(`⚠️ Duplikat ditemukan: "${analisa}" sudah ada di status "${status}". Data ini tidak akan diproses.`);
            return null; // Kalau sudah ada, jangan diproses lagi
          }

          statusCount[status]++;
          const entry = {
            pic,
            "SHIFT": shift,
            "ANALISA": analisa,
            status,
            timestamp
          };
          
          processedData.push(entry); // Tambahkan ke array yang sudah diproses
          return entry;
        }).filter(item => item !== null); // Filter untuk menghapus data yang duplikat

        try {
            const response = await fetch('https://mjlgvgpsexudwfhjpacy.supabase.co/rest/v1/input_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbGd2Z3BzZXh1ZHdmaGpwYWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NDQ1OTUsImV4cCI6MjA2MjAyMDU5NX0.4pDVg5ffOnqTmln27EzYArVMUIIcj4sUgCvu0Zawkf0', // Ganti dengan API key yang valid
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbGd2Z3BzZXh1ZHdmaGpwYWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NDQ1OTUsImV4cCI6MjA2MjAyMDU5NX0.4pDVg5ffOnqTmln27EzYArVMUIIcj4sUgCvu0Zawkf0' // Ganti dengan token yang valid
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
              let summary = `✅ Berhasil kirim ${data.length} data:\n`;
              if (statusCount["Tiket"]) summary += `- ${statusCount["Tiket"]} Tiket\n`;
              if (statusCount["Tiket Merge"]) summary += `- ${statusCount["Tiket Merge"]} Tiket Merge\n`;
              if (statusCount["Grup"]) summary += `- ${statusCount["Grup"]} Grup\n`;
              if (statusCount["Tiket Akses Web"]) summary += `- ${statusCount["Tiket Akses Web"]} Tiket Akses Web\n`;
              alert(summary);
              fileInput.value = '';
              document.getElementById("previewArea").innerHTML = '';
            } else {
              const err = await response.text();
              alert("❌ Gagal kirim data: " + err);
            }
          } catch (err) {
            alert("❌ Error saat kirim: " + err.message);
          }
        }

function getGroup(rawAnalisa) {
  if (rawAnalisa.includes("Grup")) {
    return "Grup";
  }
  return ""; // Return kosong jika tidak mengandung "Grup"
}

function getTicketMerge(rawAnalisa) {
  if (rawAnalisa.includes("Tiket Merge")) {
    return "Tiket Merge";
  }
  return ""; // Return kosong jika tidak mengandung "Tiket Merge"
}

    async function fetchData(year, month) {
      const startDate = `${year}-${month}-01`;
      const endDate = new Date(year, parseInt(month), 1).toISOString().split('T')[0]; // Bulan berikutnya

      const allData = [];
      let offset = 0;
      const limit = 1000;

      while (true) {
        const rangeStart = offset;
        const rangeEnd = offset + limit - 1;

        const url = `https://mjlgvgpsexudwfhjpacy.supabase.co/rest/v1/input_db?timestamp=gte.${startDate}&timestamp=lt.${endDate}&select=*`;

        const response = await fetch(url, {
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbGd2Z3BzZXh1ZHdmaGpwYWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NDQ1OTUsImV4cCI6MjA2MjAyMDU5NX0.4pDVg5ffOnqTmln27EzYArVMUIIcj4sUgCvu0Zawkf0',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qbGd2Z3BzZXh1ZHdmaGpwYWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NDQ1OTUsImV4cCI6MjA2MjAyMDU5NX0.4pDVg5ffOnqTmln27EzYArVMUIIcj4sUgCvu0Zawkf0',
            'Range': `${rangeStart}-${rangeEnd}`,
            'Range-Unit': 'items'
          }
        });

        if (!response.ok) {
          console.error("Gagal fetch:", await response.text());
          return [];
        }

        const data = await response.json();
        allData.push(...data);

        if (data.length < limit) break; // Tidak ada data tambahan, berhenti
        offset += limit;
      }

      console.log(`Total data diambil: ${allData.length}`);
      return allData;
    }

    async function handleExport() {
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value;

      const data = await fetchData(year, month);

      if (data.length > 0) {
        const csv = convertToCSV(data);
        downloadCSV(csv, `data_${month}_${year}.csv`);
      } else {
        alert('Data tidak ditemukan untuk bulan & tahun ini.');
      }
    }

    function convertToCSV(objArray) {
      const headers = Object.keys(objArray[0]);
      const rows = objArray.map(obj =>
        headers.map(header => {
          const value = obj[header];
          if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        }).join(',')
      );
      return [headers.join(','), ...rows].join('\n');
    }


    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const hiddenElement = document.createElement('a');
      hiddenElement.href = url;
      hiddenElement.download = filename;
      hiddenElement.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
